<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://example.com/concepts/working-with-semi-structured-data/ingesting-semi-structured-data/">
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>Ingesting semi-structured data - Firebolt docs process</title>
        <link href="../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../..">Firebolt docs process</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../../.." class="nav-link">Home</a>
                            </li>
                            <li class="navitem">
                                <a href="../../.." class="nav-link">Getting started</a>
                            </li>
                            <li class="navitem">
                                <a href="../../../architecture-overview/" class="nav-link">Architecture overview</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Working with engines <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="/working-with-engines/understanding-engine-fundamentals.md" class="dropdown-item">Understanding engine fundamentals</a>
</li>
                                    
<li>
    <a href="/working-with-engines/working-with-engines-using-ddl.md" class="dropdown-item">Working with engines using DDL</a>
</li>
                                    
<li>
    <a href="/working-with-engines/working-with-engines-using-the-rest-api.md" class="dropdown-item">Working with engines using the REST API</a>
</li>
                                    
<li>
    <a href="/working-with-engines/working-with-engines-using-the-firebolt-manager.md" class="dropdown-item">Working with engines using the Firebolt Manager</a>
</li>
                                    
<li>
    <a href="/working-with-engines/tuning-engine-performance.md" class="dropdown-item">Tuning engine performance</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Concepts <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="/concepts/working-with-tables.md" class="dropdown-item">Working with tables</a>
</li>
                                    
<li>
    <a href="/concepts/get-instant-query-response-time.md" class="dropdown-item">Using indexes</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Working with semi-structured data</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="/concepts/working-with-semi-structured-data/README.md" class="dropdown-item">Overview</a>
</li>
            
<li>
    <a href="/concepts/working-with-semi-structured-data/working-with-arrays.md" class="dropdown-item">Working with arrays</a>
</li>
            
<li>
    <a href="/concepts/working-with-semi-structured-data/ingesting-semi-structured-data.md" class="dropdown-item">Ingesting semi-structured data</a>
</li>
            
<li>
    <a href="/concepts/working-with-semi-structured-data/working-with-parquet-arrays-of-structs-and-maps.md" class="dropdown-item">Working with Parquet arrays and maps</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Writing, editing, and running SQL <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="/working-with-our-sql-editor/README.md" class="dropdown-item">Working with the SQL workspace</a>
</li>
                                    
<li>
    <a href="/working-with-our-sql-editor/keyboard-shortcuts-for-sql-workspace.md" class="dropdown-item">Keyboard shortcuts</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Loading data <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="/loading-data/loading-data-into-firebolt.md" class="dropdown-item">-Working with external tables</a>
</li>
                                    
<li>
    <a href="/loading-data/continuously-loading-data.md" class="dropdown-item">-Incrementally loading data tutorial</a>
</li>
                                    
<li>
    <a href="/loading-data/configuring-aws-role-access-amazon-s3.md" class="dropdown-item">-Using AWS roles to access Amazon S3</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="/integrations/integration-overview.md" class="nav-link">Integrations overview</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#ingesting-semi-structured-data" class="nav-link">Ingesting semi-structured data</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#extracting-top-level-scalars-and-arrays" class="nav-link">Extracting top-level scalars and arrays</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#extracting-sub-object-keys-and-values" class="nav-link">Extracting sub-object keys and values</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="ingesting-semi-structured-data">Ingesting semi-structured data</h1>
<p>There are three major approaches to ingest and handle semi-structured data:</p>
<ol>
<li>Transforming the input using JSON and <code>ARRAY</code> functions to fit the target schema during ingestion.</li>
<li>Ingesting the JSON object as raw <code>TEXT</code> rows, and later using JSON and <code>ARRAY</code> functions to query and manipulate them</li>
<li>When the input JSON adheres to a fixed schema, that is, each object has a known set of keys, and the nesting level of at most 2 (not including nesting of arrays which as stated - can be arbitrary) the data can be ingested directly. Omitted keys can be handled by specifying default values for the respective columns, but keys that are defined at table creation time will be ignored.</li>
</ol>
<p>All options can be combined depending on the use case: the nature of the input data and the queries to be performed. The 3rd approach is not very common with true semi-structured data sources, but usually is the result of an export from table-oriented storage, and therefore will be discussed in a separate section.</p>
<p>We will continue with our source JSON example. Assume that each JSON record is stored as plain text in the column <code>raw_json</code> of a (potentially external) table named <code>source_json</code></p>
<p>As a reminder here are the JSON records:</p>
<pre><code class="language-javascript">// 1st record
{
    &quot;id&quot;: 1,
    &quot;StartTime&quot;: &quot;2020-01-06 17:00:00&quot;,
    &quot;Duration&quot;: 450,
    &quot;tags&quot;: [&quot;summer-sale&quot;,&quot;sports&quot;],
    &quot;user_agent&quot;:{
        &quot;agent&quot;: &quot;Mozilla/5.0&quot;,
        &quot;platform&quot;: &quot;Windows NT 6.1&quot;,
        &quot;resolution&quot;: &quot;1024x4069&quot;
    }
}

// 2nd record
{
    &quot;id&quot;: 2,
    &quot;StartTime&quot;: &quot;2020-01-05 12:00:00&quot;,
    &quot;Duration&quot;: 959,
    &quot;tags&quot;: [&quot;gadgets&quot;,&quot;audio&quot;],
    &quot;user_agent&quot;:{
        &quot;agent&quot;: &quot;Safari&quot;,
        &quot;platform&quot;: &quot;iOS 14&quot;
    }
}
</code></pre>
<p>Recall that the target table named "Visits" should look as follows:</p>
<table>
<thead>
<tr>
<th align="left">id INT</th>
<th align="left">StartTime DATETIME</th>
<th align="left">Duration INT</th>
<th align="left">tags ARRAY(TEXT)</th>
<th align="left">agent_props_keys</th>
<th align="left">agent_props_vals</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">1</td>
<td align="left">2020-01-06 17:00:00</td>
<td align="left">450</td>
<td align="left">["summer-sale","sports"]</td>
<td align="left">["agent", "platform", "resolution"]</td>
<td align="left">["Mozilla/5.0", "Windows NT 6.1", "1024x4069"]</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">2020-01-05 12:00:00</td>
<td align="left">959</td>
<td align="left">["gadgets","audio"]</td>
<td align="left">["agent", "platform"]</td>
<td align="left">["Safari", "iOS 14"]</td>
</tr>
</tbody>
</table>
<h2 id="extracting-top-level-scalars-and-arrays">Extracting top-level scalars and arrays</h2>
<p>For the top-level keys: "id", "Duration", and "tags" the task is straightforward using <a href="../../../sql-reference/functions-reference/semi-structured-functions/json-functions/#json_extract">JSON_EXTRACT</a> function. This function accepts three parameters:</p>
<p>Although "StartTime" is also a scalar field, since there is no native DATETIME type in JSON type system it will require an additional step</p>
<ol>
<li>An expression containing a JSON string</li>
<li>A <a href="./">JSON Pointer</a> specifying the location in the JSON object from where the value will be extracted,</li>
<li>A type specifier indicating Firebolt's SQL type that will be returned from the function. This type should correspond to the JSON type found under the key pointed by the JSON Pointer. For a detailed discussion of JSON to SQL type mapping see the <a href="../../../sql-reference/functions-reference/semi-structured-functions/json-functions/#type-parameters">Type Parameters</a> section in the <a href="../../../sql-reference/functions-reference/semi-structured-functions/json-functions/">JSON Functions</a> reference.</li>
</ol>
<p>Note that our native support for arrays makes the extraction of <code>tags</code> as simple as other scalar types. Putting those concepts in action will result in the following query that will return the expected tabular representation:</p>
<pre><code class="language-sql">SELECT
JSON_EXTRACT(raw_json, '/id','INT') as id,
JSON_EXTRACT(raw_json, '/Duration','INT') as duration,
JSON_EXTRACT(raw_json, '/tags','ARRAY(TEXT)') as tags
FROM source_json
</code></pre>
<p>Result:</p>
<table>
<thead>
<tr>
<th align="left">id</th>
<th align="left">duration</th>
<th align="left">tags</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">1</td>
<td align="left">450</td>
<td align="left">["summer-sale","sports"]</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">959</td>
<td align="left">["gadgets","audio"]</td>
</tr>
</tbody>
</table>
<p>Since we want to store "StartTime" as a <code>DATETIME</code> SQL typed column, which will allow many optimizations, correct ordering, and other benefits, and since JSON type system lacks such type we will have to cast the result of <code>JSON_EXTRACT</code> of this field:</p>
<pre><code class="language-sql">SELECT
-- ... other fields
CAST(JSON_EXTRACT(raw_json, '/StartTime','TEXT') AS DATETIME)
FROM source_json
</code></pre>
<h2 id="extracting-sub-object-keys-and-values">Extracting sub-object keys and values</h2>
<p>Now we have to perform a non-trivial transformation to the input data. We need to take the JSON keys of the sub-object <code>user_agent</code> , and their corresponding values and reshape them as two coordinated arrays.</p>
<p>The functions <a href="../../../sql-reference/functions-reference/semi-structured-functions/json-functions/#json_extract_keys"><code>JSON_EXTRACT_KEYS</code></a> and <a href="../../../sql-reference/functions-reference/semi-structured-functions/json-functions/#json_extract_values"><code>JSON_EXTRACT_VALUES</code></a>do exactly this.</p>
<p>The first will return the keys under the sub-objects pointed by the JSON pointer provided as the first parameter, and the second will return the values of this sub-object <em><strong>as strings</strong></em>. That means that if under a certain key there is an arbitrarily nested sub-object - the whole object will be returned as a single <code>TEXT</code> element in the resulting array.</p>
<h3 id="putting-it-all-together">Putting it all together</h3>
<p>The following statement takes the raw JSON input and transforms it into our target schema. The result is provided as an illustration, since an <code>INSERT INTO ...</code> return only the number of affected rows.</p>
<pre><code class="language-sql">INSERT INTO Visits
SELECT
JSON_EXTRACT(raw_json, '/id','INT') as id,
CAST(JSON_EXTRACT(raw_json, '/StartTime','TEXT') AS DATETIME) as StartTime,
JSON_EXTRACT(raw_json, '/Duration','INT') as duration,
JSON_EXTRACT(raw_json, '/tags','ARRAY(TEXT)') as tags,
JSON_EXTRACT_KEYS(raw_json,'/user_agent') as agent_props_keys,
JSON_EXTRACT_VALUES(raw_json,'/user_agent') as agent_props_vals
FROM doc_visits_source
</code></pre>
<p>Result (if the script whould have been excecuted without the <code>INSERT INTO</code> clause):</p>
<table>
<thead>
<tr>
<th align="left">id</th>
<th align="left">StartTime</th>
<th align="left">duration</th>
<th align="left">tags</th>
<th align="left">agent_props_keys</th>
<th align="left">agent_props_vals</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">1</td>
<td align="left">2020-01-06 17:00:00</td>
<td align="left">450</td>
<td align="left">["summer-sale","sports"]</td>
<td align="left">["agent", "platform", "resolution"]</td>
<td align="left">["Mozilla/5.0", "Windows NT 6.1", "1024x4069"]</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">2020-01-05 12:00:00</td>
<td align="left">959</td>
<td align="left">["gadgets","audio"]</td>
<td align="left">["agent", "platform"]</td>
<td align="left">["Safari", "iOS 14"]</td>
</tr>
</tbody>
</table></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js" defer></script>
        <script src="../../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
